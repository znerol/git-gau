language: shell

dist: xenial
sudo: false

stages:
  - "Lint"
  - "Unit test"
  - name: "Integration test"
    if: fork = false AND type = push
  - name: "GitHub release"
    if: fork = false AND type = push AND tag IS present

jobs:
  include:
    - stage: "Lint"
      script:
        - make lint

    - stage: "Unit test"
      script:
        - make test

    - stage: "Integration test"
      services:
        - docker
      addons:
        apt:
          packages:
            - pandoc
      env:
        secure: SHsu/LWwcDhXWD4YemCjtGAXAfufyKT3nZX2a+MwU/SBX2B6rM8vVaV6ScrMN3Jpb7p5YKWMNtKgzWF+p+cyX+rPjtjza5TPHxE6KFsnwdA4Os/xCan85ftHg95JSzJACvOwN50K6WrCFJASsSWIQ4T3PHyiO2Y1OdNTdSUM9+bMZRpcKoO2FZb1xn7ivz+War6OBFA1FSi+6W/3tC0fzHCF3Lr6qg0Vm9v5YT5BNjb7tso8JvIEbTtBBGAWn3YlnN/5E6LRxo1hlCz9TXJQ5d4i6u1/tbsePPYhpgTADzMUQMAJ2fZuZ1m0c/e1ezAt+cip6d33tSKsXqqyoIbFGr27Xts3pnrH31OC3HBnOzBzWJoTIc9atV8vnZ3hWIZwbSLkYW0CgsWJORrVQQdD0BPgU7BPqrwB3uhd1CA78B1jnlBCkU5Px4lQEAQOlYCINBUac3bdWJTG73kqZa0R9JKIKKZ4hGUCJoG97Q3LSDnEI4bkZYzNTJYusUos/6yDo7x7QFmYrli9wrn2DrFaYNXuCD+683iWmQ37+wpUn2t53KGYttzfFzXPPDu1gTVSIe0kBd0duJ/XO4/s4Whd9VAkCv/Sa9Pe4G/PL+1xSJTtW18qMshzUnF/1yVIpKoPzcf5b6JDybV0iTaNyWPfaG//AtF0vPXm7AfXWqwSkSY=
      before_script:
        - make dist
        - make -C integration-test image
      script:
        - make -C integration-test all

    - stage: "GitHub release"
      addons:
        apt:
          packages:
            - pandoc
      script:
        - make dist
      deploy:
        provider: releases
        api_key:
          secure: d5OiTAzExGVZwwrx+a4yLGgSl60rlMP++C06AfkSclmm67UrnTj6ysLJUVnB9hy0+NPIBxCtHc4oN9ctT8ihEC2unGx/ddD+D3m6yjYLJ5tX1hyqoznaN1k0skayBPWOdgpH30QWGQp0L9TXchc6GevAteukhtai8CCSQlHMJoDsjbVhPoO5tMMqlekcDfEuTWe4Xv8t3RKF4Rf5h4h9VZUg/6nI6rGgwbi1hEvqUfu7qyK6p37yVbhy3J+29oIQhBYrpYm2JVPCNDC7n72c269EPoOeA8Ni69hD9rhf3X5q4Ncvbm4a/lXYY9Mr0uOqmYgJYZPqCkL6S3VJSDPtpAGaU3FbSdkUQCQo7SYJtaLJ55SMpIMZ5eED5t3v18wdws8R0mxufqrcKhNV78y4/lgrbhj2bmwk7V9+LtDomT/TbpqHtHzINZHuFtBHpGCX1m3y6Lei/wmihqoMtNvYHGrve4jcpZvPtJ3WTLk/z1pRR4V77Kd0VsewkEOeL6Hlnso1atK5AWnNDnOKok49Z+Cqq0JlZKWAB1hyyHlD89ebPZNtOfzZPbhhRn3VWYwYBOm2dH1FzGniC57q1kUCh26m2pRGzDvtf2qTjMLMDQG0JxEd+Nz5AkrBXj4Go7xPfzoDBghUJC/kapUCJ03a3yvHVwAOWtCf239Svz26zuA=
        file:
          - dist/git-gau-src.tar.gz
          - dist/git-gau-dist.tar.gz
        skip_cleanup: true
        draft: true
        on:
          repo: znerol/git-gau
          tags: true
